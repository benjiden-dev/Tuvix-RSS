# ============================================================================
# Cloudflare Workers Configuration
# ============================================================================
# IMPORTANT: This file uses environment variable substitution for sensitive IDs.
# DO NOT commit filled-in database_id values - they are account-specific.
# 
# Local dev: Create wrangler.toml.local with your actual database_id
# CI/CD: envsubst substitutes ${D1_DATABASE_ID} from GitHub secret before deployment
# ============================================================================

# Worker name - Wrangler uses this to identify which worker to deploy/secrets to manage
# When running wrangler commands, they target the worker named "tuvix-api"
name = "tuvix-api"
main = "src/entries/cloudflare.ts"
compatibility_date = "2024-11-10"

# Sentry requires AsyncLocalStorage for trace context
# nodejs_compat enables Node.js built-in modules (crypto, util, etc.)
compatibility_flags = ["nodejs_als", "nodejs_compat"]

# CPU time limits (requires Workers Paid plan $5/month)
# Password hashing (scrypt) requires ~3-4 seconds of CPU time
# Free tier: 10ms (insufficient for password auth)
# Paid tier: Up to 30 seconds (30000ms) available
[limits]
cpu_ms = 30000

# Version metadata for Sentry release tracking
[version_metadata]
binding = "CF_VERSION_METADATA"

# D1 Database binding
# For local dev: Create wrangler.toml.local with your actual database_id (see wrangler.toml.local.example)
# For CI/CD: envsubst substitutes ${D1_DATABASE_ID} before deployment (see .github/workflows/deploy-cloudflare.yml)
# Note: Wrangler expects migrations in ./migrations/ folder (copied from ./drizzle/ by db:migrate:d1 script)
[[d1_databases]]
binding = "DB"
database_name = "tuvix"
# Substituted by envsubst in CI/CD, or override in wrangler.toml.local for local dev
database_id = "${D1_DATABASE_ID}"

# Custom Domain Routes (Optional)
# Only needed if routing traffic from a Cloudflare zone to this Worker
# For custom domains, use: npx wrangler domains add api.yourdomain.com
# [[routes]]
# pattern = "api.yourdomain.com/*"
# zone_name = "yourdomain.com"

# Rate Limit Bindings for API and Public Feed rate limiting
# Uses Cloudflare Workers rate limit bindings
# Each plan has its own binding with the plan's rate limit
# namespace_id: A positive integer you define, unique to your Cloudflare account
# You choose these IDs yourself - they don't need to be created elsewhere



# Environment variables
[vars]
RUNTIME = "cloudflare"

# Secrets (set with: wrangler secret put BETTER_AUTH_SECRET)
# BETTER_AUTH_SECRET = "your-secret-key"


# Email Service Secrets (set with: wrangler secret put RESEND_API_KEY)
# RESEND_API_KEY = "re_xxxxxxxxx"
# EMAIL_FROM = "noreply@yourdomain.com"
# BASE_URL = "https://yourdomain.com"

# Cron trigger - polling interval (every 5 minutes)
# Actual fetch/prune timing is controlled by global_settings table
[triggers]
crons = ["*/5 * * * *"]

# Observability configuration for Workers logs
[observability]
[observability.logs]
enabled = false
head_sampling_rate = 1
invocation_logs = true
persist = true
