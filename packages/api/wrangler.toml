# ============================================================================
# Cloudflare Workers Configuration
# ============================================================================
# IMPORTANT: This file is safe to commit with empty IDs.
# DO NOT commit filled-in database_id or KV namespace IDs - they are
# account-specific. Use wrangler.toml.local for local overrides if needed.
# ============================================================================

name = "tuvix-api"
main = "src/adapters/cloudflare.ts"
compatibility_date = "2024-11-10"

# Sentry requires AsyncLocalStorage for trace context
compatibility_flags = ["nodejs_als"]

# Version metadata for Sentry release tracking
[version_metadata]
binding = "CF_VERSION_METADATA"

# D1 Database binding
[[d1_databases]]
binding = "DB"
database_name = "tuvix"
database_id = "" # Add your database ID after creating: wrangler d1 create tuvix

# R2 Storage binding
[[r2_buckets]]
binding = "R2_BUCKET"
bucket_name = "tuvix-storage"

# Rate Limit Bindings for API and Public Feed rate limiting
# Uses Cloudflare Workers rate limit bindings
# Each binding defines a limit and period (10s or 60s)
# We use a high limit and enforce user-specific limits in code
# First, create namespaces: wrangler rate-limit namespace create "API_RATE_LIMIT" and "FEED_RATE_LIMIT"
[[ratelimits]]
name = "API_RATE_LIMIT"
namespace_id = "" # Add your namespace ID after creating: wrangler rate-limit namespace create "API_RATE_LIMIT"
simple = { limit = 10000, period = 60 }  # High limit - actual limits enforced per user via getUserLimits()

[[ratelimits]]
name = "FEED_RATE_LIMIT"
namespace_id = "" # Add your namespace ID after creating: wrangler rate-limit namespace create "FEED_RATE_LIMIT"
simple = { limit = 10000, period = 60 }  # High limit - actual limits enforced per user via getUserLimits()

# Environment variables
[vars]
RUNTIME = "cloudflare"

# Secrets (set with: wrangler secret put BETTER_AUTH_SECRET)
# BETTER_AUTH_SECRET = "your-secret-key"


# Email Service Secrets (set with: wrangler secret put RESEND_API_KEY)
# RESEND_API_KEY = "re_xxxxxxxxx"
# EMAIL_FROM = "noreply@yourdomain.com"
# BASE_URL = "https://yourdomain.com"

# Cron trigger - polling interval (every 5 minutes)
# Actual fetch/prune timing is controlled by global_settings table
[triggers]
crons = ["*/5 * * * *"]
