name: Docker Build & Test

on:
  pull_request:
    paths:
      - 'packages/api/**'
      - 'packages/app/**'
      - 'packages/tricorder/**'
      - 'docker-compose.yml'
      - 'docker-compose.test.yml'
      - '**/Dockerfile'
      - '.dockerignore'
      - 'package.json'
      - 'pnpm-lock.yaml'
  push:
    branches:
      - main
      - dev

env:
  # CI-specific environment variables
  BETTER_AUTH_SECRET: test-secret-for-ci-must-be-at-least-32-characters-long-xyz
  CORS_ORIGIN: http://localhost:5173
  DATABASE_PATH: /app/data/test.db

jobs:
  docker-build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images
        run: |
          echo "ðŸ“¦ Building Docker images..."
          docker compose build
        env:
          COMPOSE_DOCKER_CLI_BUILD: 1
          DOCKER_BUILDKIT: 1

      - name: Check image sizes
        run: |
          echo "ðŸ“ Checking image sizes..."

          # Get image sizes
          API_SIZE_RAW=$(docker images --format "{{.Size}}" tuvixrss-api:latest)
          APP_SIZE_RAW=$(docker images --format "{{.Size}}" tuvixrss-app:latest)

          echo "API Image: ${API_SIZE_RAW}"
          echo "App Image: ${APP_SIZE_RAW}"

          # Extract numeric size (handle both MB and GB)
          API_SIZE=$(echo "$API_SIZE_RAW" | sed 's/MB//' | sed 's/GB/*1024/' | bc 2>/dev/null || echo "$API_SIZE_RAW" | sed 's/[^0-9.]//g')
          APP_SIZE=$(echo "$APP_SIZE_RAW" | sed 's/MB//' | sed 's/GB/*1024/' | bc 2>/dev/null || echo "$APP_SIZE_RAW" | sed 's/[^0-9.]//g')

          # Convert to integer for comparison
          API_SIZE_INT=$(printf "%.0f" "$API_SIZE" 2>/dev/null || echo "0")
          APP_SIZE_INT=$(printf "%.0f" "$APP_SIZE" 2>/dev/null || echo "0")

          # Check size limits (API: 400MB, App: 100MB)
          if [ "$API_SIZE_INT" -gt 400 ]; then
            echo "âŒ API image too large: ${API_SIZE_RAW} (limit: 400MB)"
            exit 1
          fi

          if [ "$APP_SIZE_INT" -gt 100 ]; then
            echo "âŒ App image too large: ${APP_SIZE_RAW} (limit: 100MB)"
            exit 1
          fi

          echo "âœ… Image sizes within limits"
          echo "api_size=${API_SIZE_RAW}" >> $GITHUB_OUTPUT
          echo "app_size=${APP_SIZE_RAW}" >> $GITHUB_OUTPUT

      - name: Prepare data directory
        run: |
          echo "ðŸ“ Creating data directory with proper permissions..."
          mkdir -p ./data
          # Set permissions so container user (uid 1001) can write
          chmod 777 ./data
          ls -la ./data

      - name: Start API container
        run: |
          echo "ðŸš€ Starting API container..."
          docker compose up -d api --wait=false

          echo "ðŸ“‹ Container status:"
          docker ps -a

          echo ""
          echo "ðŸ” Initial API logs:"
          sleep 2
          docker logs tuvix-api 2>&1 | head -30 || echo "No logs yet"

      - name: Wait for API to be healthy
        run: |
          echo "â³ Waiting for API to be healthy (max 90s)..."
          SECONDS=0
          MAX_WAIT=90

          while [ $SECONDS -lt $MAX_WAIT ]; do
            STATUS=$(docker inspect --format="{{.State.Health.Status}}" tuvix-api 2>/dev/null || echo "none")
            echo "[$SECONDS s] API health status: $STATUS"

            if [ "$STATUS" = "healthy" ]; then
              echo "âœ… API is healthy!"
              break
            fi

            # Show recent logs every 10 seconds
            if [ $((SECONDS % 10)) -eq 0 ]; then
              echo "ðŸ“œ Recent API logs:"
              docker logs tuvix-api 2>&1 | tail -20
            fi

            sleep 2
          done

          if [ $SECONDS -ge $MAX_WAIT ]; then
            echo "âŒ API failed to become healthy after ${MAX_WAIT}s"
            echo ""
            echo "ðŸ“‹ Container status:"
            docker ps -a
            echo ""
            echo "ðŸ“œ Full API logs:"
            docker logs tuvix-api 2>&1
            exit 1
          fi

      - name: Start App container
        run: |
          echo "ðŸš€ Starting App container..."
          docker compose up -d app

          echo "ðŸ“‹ Container status:"
          docker ps -a

      - name: Wait for App to be healthy
        run: |
          echo "â³ Waiting for App to be healthy (max 60s)..."
          SECONDS=0
          MAX_WAIT=60

          while [ $SECONDS -lt $MAX_WAIT ]; do
            STATUS=$(docker inspect --format="{{.State.Health.Status}}" tuvix-app 2>/dev/null || echo "none")
            echo "[$SECONDS s] App health status: $STATUS"

            if [ "$STATUS" = "healthy" ]; then
              echo "âœ… App is healthy!"
              break
            fi

            sleep 2
          done

          if [ $SECONDS -ge $MAX_WAIT ]; then
            echo "âŒ App failed to become healthy after ${MAX_WAIT}s"
            echo ""
            echo "ðŸ“‹ Container status:"
            docker ps -a
            echo ""
            echo "ðŸ“œ Full App logs:"
            docker logs tuvix-app 2>&1
            exit 1
          fi

      - name: Test API health endpoint
        run: |
          echo "ðŸ” Testing API health endpoint..."
          RESPONSE=$(curl -s http://localhost:3001/health)
          echo "Response: $RESPONSE"

          if echo "$RESPONSE" | grep -q '"status":"ok"'; then
            echo "âœ… API health check passed"
          else
            echo "âŒ API health check failed"
            exit 1
          fi

      - name: Test App health endpoint
        run: |
          echo "ðŸ” Testing App health endpoint..."
          RESPONSE=$(curl -s http://localhost:5173/health)
          echo "Response: $RESPONSE"

          if echo "$RESPONSE" | grep -q 'ok'; then
            echo "âœ… App health check passed"
          else
            echo "âŒ App health check failed"
            exit 1
          fi

      - name: Verify containers run as non-root
        run: |
          echo "ðŸ”’ Verifying security (non-root users)..."

          API_USER=$(docker exec tuvix-api id -u)
          APP_USER=$(docker exec tuvix-app id -u)

          echo "API running as uid: $API_USER"
          echo "App running as uid: $APP_USER"

          if [ "$API_USER" = "0" ]; then
            echo "âŒ API running as root"
            exit 1
          fi

          if [ "$APP_USER" = "0" ]; then
            echo "âŒ App running as root"
            exit 1
          fi

          if [ "$API_USER" != "1001" ]; then
            echo "âš ï¸  Warning: API not running as expected user (expected: 1001, got: $API_USER)"
          fi

          if [ "$APP_USER" != "1001" ]; then
            echo "âš ï¸  Warning: App not running as expected user (expected: 1001, got: $APP_USER)"
          fi

          echo "âœ… All containers running as non-root"

      - name: Verify database migrations
        run: |
          echo "ðŸ—„ï¸  Verifying database migrations..."

          # Check if database exists
          if docker exec tuvix-api test -f /app/data/test.db; then
            echo "âœ… Database file created"
            docker exec tuvix-api ls -lh /app/data/test.db
          else
            echo "âŒ Database file not found"
            exit 1
          fi

          # Check migration logs
          if docker logs tuvix-api 2>&1 | grep -q "Migrations complete\|âœ… Migrations completed"; then
            echo "âœ… Migrations executed successfully"
          else
            echo "âŒ Migrations not found in logs"
            docker logs tuvix-api 2>&1 | grep -i migration || echo "No migration logs found"
            exit 1
          fi

      - name: Run smoke tests
        run: |
          echo "ðŸ§ª Running smoke tests..."

          # Test that API is responding
          curl -f http://localhost:3001/health || exit 1

          # Test that App is serving content
          curl -f http://localhost:5173/ || exit 1

          # Test that App serves static assets
          curl -f http://localhost:5173/health || exit 1

          echo "âœ… All smoke tests passed"

      - name: Show container stats
        if: always()
        run: |
          echo "ðŸ“Š Container statistics:"
          docker stats --no-stream

          echo ""
          echo "ðŸ“‹ Container details:"
          docker ps -a

      - name: Show logs on failure
        if: failure()
        run: |
          echo "===================="
          echo "=== API Logs ==="
          echo "===================="
          docker logs tuvix-api

          echo ""
          echo "===================="
          echo "=== App Logs ==="
          echo "===================="
          docker logs tuvix-app

          echo ""
          echo "===================="
          echo "=== Docker Compose Logs ==="
          echo "===================="
          docker compose logs

      - name: Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up..."
          docker compose down -v
          docker system prune -af --volumes
