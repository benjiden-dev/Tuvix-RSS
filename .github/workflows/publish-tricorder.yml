name: Publish Tricorder Package

on:
  # Trigger on version tags for tricorder (supports both formats)
  push:
    tags:
      - 'tricorder-v*.*.*'
      - '@tuvixrss/tricorder@*.*.*'

  # Trigger on GitHub releases for tricorder package
  release:
    types: [published]

  # Manual trigger with version input
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.0.1)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (test without publishing)'
        required: false
        type: boolean
        default: false

env:
  PNPM_VERSION: 10.19.0
  NODE_VERSION: '20'

permissions:
  id-token: write  # Required for OIDC trusted publishing
  contents: read   # Required to read repository contents

jobs:
  # Check if this release is for tricorder package
  check-package:
    name: Check if tricorder package release
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    outputs:
      should-publish: ${{ steps.check.outputs.should-publish }}
    steps:
      - name: Check release tag format
        id: check
        run: |
          TAG="${{ github.event.release.tag_name }}"
          if [[ "$TAG" =~ ^(tricorder-v|@tuvixrss/tricorder@) ]]; then
            echo "should-publish=true" >> $GITHUB_OUTPUT
            echo "âœ… Tricorder package release detected: $TAG"
          else
            echo "should-publish=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  Not a tricorder release: $TAG - skipping publish"
          fi

  # Verify tricorder package independently
  verify:
    name: Verify Tricorder Package
    runs-on: ubuntu-latest
    needs: [check-package]
    if: |
      always() &&
      (needs.check-package.result == 'skipped' || needs.check-package.outputs.should-publish == 'true')
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js and pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint tricorder
        run: pnpm --filter @tuvixrss/tricorder lint

      - name: Format check tricorder
        run: pnpm --filter @tuvixrss/tricorder format:check

      - name: Type check tricorder
        run: pnpm --filter @tuvixrss/tricorder type-check

      - name: Test tricorder
        run: pnpm --filter @tuvixrss/tricorder test

      - name: Build tricorder
        run: pnpm --filter @tuvixrss/tricorder build

      - name: Verify package contents
        run: |
          cd packages/tricorder
          npm pack --dry-run

      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: tricorder-dist
          path: packages/tricorder/dist
          retention-days: 7

  # Publish to NPM
  publish:
    name: Publish to NPM
    runs-on: ubuntu-latest
    needs: verify
    if: ${{ !inputs.dry_run }}
    environment:
      name: npm-registry
      url: https://www.npmjs.com/package/@tuvixrss/tricorder
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js and pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js with NPM registry
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Update npm to latest version
        run: npm install -g npm@latest

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build tricorder
        run: pnpm --filter @tuvixrss/tricorder build

      - name: Extract and set version from tag/release
        id: version
        run: |
          # Extract version from tag (if tag push) or release (if release event)
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG_REF="${{ github.event.release.tag_name }}"
          else
            TAG_REF=${GITHUB_REF#refs/tags/}
          fi

          # Extract version from either format:
          # - tricorder-vX.Y.Z -> X.Y.Z
          # - @tuvixrss/tricorder@X.Y.Z -> X.Y.Z
          if [[ "$TAG_REF" =~ ^tricorder-v(.+)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
          elif [[ "$TAG_REF" =~ ^@tuvixrss/tricorder@(.+)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
          else
            echo "âŒ Invalid tag format: $TAG_REF"
            echo "Expected format: tricorder-vX.Y.Z or @tuvixrss/tricorder@X.Y.Z"
            exit 1
          fi

          # Validate semantic version format (major.minor.patch with optional pre-release)
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$'; then
            echo "âŒ Invalid version format: $VERSION"
            echo "Expected format: X.Y.Z or X.Y.Z-prerelease"
            echo "Examples: 1.0.0, 1.2.3, 2.0.0-beta.1"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Publishing version: $VERSION"

      - name: Update package.json version
        run: |
          cd packages/tricorder
          npm version ${{ steps.version.outputs.version }} --no-git-tag-version
          echo "âœ… Updated package.json to version ${{ steps.version.outputs.version }}"

      - name: Check if version already published
        id: check_version
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          if npm view @tuvixrss/tricorder@$VERSION version 2>/dev/null; then
            echo "âš ï¸  Version $VERSION is already published to NPM"
            echo "already_published=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Version $VERSION is not published yet"
            echo "already_published=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish to NPM
        if: steps.check_version.outputs.already_published == 'false'
        run: |
          cd packages/tricorder
          npm publish

      - name: Skip publish (already published)
        if: steps.check_version.outputs.already_published == 'true'
        run: |
          echo "â­ï¸  Skipping publish - version already exists on NPM"

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/') && steps.check_version.outputs.already_published == 'false'
        uses: actions/github-script@v8
        with:
          script: |
            const tagRef = context.ref.replace('refs/tags/', '');

            // Extract version from either format:
            // - tricorder-vX.Y.Z -> X.Y.Z
            // - @tuvixrss/tricorder@X.Y.Z -> X.Y.Z
            let version;
            if (tagRef.startsWith('tricorder-v')) {
              version = tagRef.replace('tricorder-v', '');
            } else if (tagRef.startsWith('@tuvixrss/tricorder@')) {
              version = tagRef.replace('@tuvixrss/tricorder@', '');
            } else {
              throw new Error(`Invalid tag format: ${tagRef}`);
            }

            // Check if release already exists
            let releaseExists = false;
            try {
              await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: context.ref.replace('refs/tags/', '')
              });
              releaseExists = true;
              console.log('âœ… Release already exists - skipping creation');
            } catch (error) {
              if (error.status !== 404) throw error;
            }

            if (!releaseExists) {
              await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: context.ref.replace('refs/tags/', ''),
                name: `@tuvixrss/tricorder v${version}`,
                body: `# Tricorder ${version}\n\nRSS and Atom feed discovery library for Node.js and browsers.\n\n## NPM\nhttps://www.npmjs.com/package/@tuvixrss/tricorder/v/${version}`,
                draft: false,
                prerelease: version.includes('-')
              });
              console.log('âœ… GitHub release created');
            }

      - name: Output published version
        if: steps.check_version.outputs.already_published == 'false'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "ðŸ“¦ Successfully published @tuvixrss/tricorder@$VERSION"
          echo "ðŸ”— https://www.npmjs.com/package/@tuvixrss/tricorder/v/$VERSION"
