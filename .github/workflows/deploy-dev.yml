name: Deploy to Cloudflare Workers (Dev)

on:
  push:
    branches:
      - development
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy (default: development)'
        required: false
        default: 'development'
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PNPM_VERSION: 10.19.0
  NODE_VERSION: '20'

jobs:
  deploy-api:
    name: Deploy API to Cloudflare Workers (Dev)
    runs-on: ubuntu-latest
    environment:
      name: development
    env:
      # Set from secret for conditional step execution
      SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type check API
        run: pnpm run type-check:api

      - name: Run API tests
        run: pnpm run test:api

      - name: Build API
        run: pnpm run build:api

      - name: Substitute D1 database ID
        env:
          D1_DATABASE_ID: ${{ secrets.D1_DATABASE_ID }}
        run: |
          # Verify secret is set (without leaking value)
          if [ -z "$D1_DATABASE_ID" ]; then
            echo "::error::D1_DATABASE_ID secret is not set"
            exit 1
          fi
          
          # Verify placeholder exists in file
          if ! grep -q '\${D1_DATABASE_ID}' packages/api/wrangler.toml; then
            echo "::error::Placeholder \${D1_DATABASE_ID} not found in wrangler.toml"
            exit 1
          fi
          
          # Perform substitution with explicit variable list
          envsubst '$D1_DATABASE_ID' < packages/api/wrangler.toml > packages/api/wrangler.toml.tmp
          
          # Verify substitution succeeded (placeholder should be gone)
          if grep -q '\${D1_DATABASE_ID}' packages/api/wrangler.toml.tmp; then
            echo "::error::Substitution failed - placeholder still present"
            exit 1
          fi
          
          # Verify database_id is not empty after substitution
          if grep -q 'database_id = ""' packages/api/wrangler.toml.tmp; then
            echo "::error::database_id is empty after substitution"
            exit 1
          fi
          
          # Move substituted file into place
          mv packages/api/wrangler.toml.tmp packages/api/wrangler.toml
          
          echo "âœ… Successfully substituted D1_DATABASE_ID (value not logged for security)"

      - name: Check if dev worker name override is set
        id: check-dev-worker-name
        run: |
          # Check if secret exists and is not empty
          if [ -n "${{ secrets.CLOUDFLARE_WORKER_NAME_DEV }}" ]; then
            echo "override=true" >> $GITHUB_OUTPUT
          else
            echo "override=false" >> $GITHUB_OUTPUT
          fi

      - name: Get worker name
        id: worker-name
        run: |
          # Use dev worker name from secret if set, otherwise use default from wrangler.toml
          if [ -n "${{ secrets.CLOUDFLARE_WORKER_NAME_DEV }}" ]; then
            WORKER_NAME="${{ secrets.CLOUDFLARE_WORKER_NAME_DEV }}"
          else
            # Get the first 'name =' line (worker name), not rate limit binding names
            WORKER_NAME=$(grep -m 1 '^name =' packages/api/wrangler.toml | cut -d'"' -f2)
          fi
          echo "name=$WORKER_NAME" >> $GITHUB_OUTPUT
          echo "Deploying to Worker: $WORKER_NAME"

      - name: Override worker name for dev (if specified)
        if: steps.check-dev-worker-name.outputs.override == 'true'
        run: |
          # Temporarily override worker name in wrangler.toml for dev deployment
          WORKER_NAME="${{ secrets.CLOUDFLARE_WORKER_NAME_DEV }}"
          cd packages/api
          # Backup original
          cp wrangler.toml wrangler.toml.backup
          # Replace name line (works on both Linux and macOS)
          sed -i.bak "s/^name = \".*\"/name = \"$WORKER_NAME\"/" wrangler.toml
          rm -f wrangler.toml.bak
          echo "âœ… Overridden worker name to: $WORKER_NAME"

      - name: Get deployment version
        id: deployment-version
        run: |
          DEPLOYMENT_VERSION="${{ github.sha }}"
          echo "version=$DEPLOYMENT_VERSION" >> $GITHUB_OUTPUT
          echo "Deployment version: $DEPLOYMENT_VERSION (commit: ${DEPLOYMENT_VERSION:0:7})"

      - name: Set Sentry Release (Backend)
        if: env.SENTRY_DSN != ''
        run: |
          # Only set if SENTRY_DSN secret exists (Sentry is configured)
          # Set secret using wrangler with stdin (non-interactive)
          DEPLOYMENT_VERSION="${{ steps.deployment-version.outputs.version }}"
          WORKER_NAME="${{ steps.worker-name.outputs.name }}"
          cd packages/api
          # Use --name flag to target the correct worker
          echo "$DEPLOYMENT_VERSION" | npx wrangler secret put SENTRY_RELEASE --name "$WORKER_NAME"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy to Cloudflare Workers
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: packages/api
          command: deploy
          wranglerVersion: "3"
        env:
          # Override worker name if dev-specific name is provided
          WRANGLER_SEND_METRICS: "false"

      - name: Output API deployment URL
        if: success()
        run: |
          API_URL="https://${{ steps.worker-name.outputs.name }}.workers.dev"
          echo "API_URL=$API_URL" >> $GITHUB_OUTPUT
          echo "## API Deployment (Dev)" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** $API_URL" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${GITHUB_SHA:0:7}\`" >> $GITHUB_STEP_SUMMARY

      - name: Restore original wrangler.toml
        if: always() && steps.check-dev-worker-name.outputs.override == 'true'
        run: |
          cd packages/api
          if [ -f wrangler.toml.backup ]; then
            mv wrangler.toml.backup wrangler.toml
            echo "âœ… Restored original wrangler.toml"
          fi

      - name: Run database migrations
        if: success()
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: packages/api
          command: d1 migrations apply tuvix --remote
        env:
          D1_DATABASE_ID: ${{ secrets.D1_DATABASE_ID }}

  deploy-app:
    name: Deploy App to Cloudflare Pages (Dev)
    runs-on: ubuntu-latest
    needs: [deploy-api]
    environment:
      name: development
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type check App
        run: pnpm run type-check:app

      - name: Run App tests
        run: pnpm run test:app

      - name: Get deployment version
        id: deployment-version
        run: |
          DEPLOYMENT_VERSION="${{ github.sha }}"
          echo "version=$DEPLOYMENT_VERSION" >> $GITHUB_OUTPUT
          echo "Deployment version: $DEPLOYMENT_VERSION (commit: ${DEPLOYMENT_VERSION:0:7})"

      - name: Build App
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_SENTRY_RELEASE: ${{ steps.deployment-version.outputs.version }}
        run: pnpm run build:app

      - name: Deploy to Cloudflare Pages
        id: deploy-app
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ${{ secrets.CLOUDFLARE_PAGES_PROJECT_NAME }}
          directory: packages/app/dist

      - name: Output App deployment URL
        if: success()
        run: |
          APP_URL="https://${{ secrets.CLOUDFLARE_PAGES_PROJECT_NAME }}.pages.dev"
          echo "APP_URL=$APP_URL" >> $GITHUB_OUTPUT
          echo "## App Deployment (Dev)" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** $APP_URL" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${GITHUB_SHA:0:7}\`" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-api, deploy-app]
    if: always()
    environment:
      name: development
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get worker name
        id: worker-name
        run: |
          # Use dev worker name from secret if set, otherwise use default from wrangler.toml
          if [ -n "${{ secrets.CLOUDFLARE_WORKER_NAME_DEV }}" ]; then
            WORKER_NAME="${{ secrets.CLOUDFLARE_WORKER_NAME_DEV }}"
          else
            # Get the first 'name =' line (worker name), not rate limit binding names
            WORKER_NAME=$(grep -m 1 '^name =' packages/api/wrangler.toml | cut -d'"' -f2)
          fi
          echo "name=$WORKER_NAME" >> $GITHUB_OUTPUT

      - name: Deployment Summary
        run: |
          WORKER_NAME="${{ steps.worker-name.outputs.name }}"
          echo "## ðŸš€ Dev Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed commit:** \`${GITHUB_SHA:0:7}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|-----|" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.deploy-api.result }}" == "success" ]; then
            echo "| API | âœ… Success | https://${WORKER_NAME}.workers.dev |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| API | âŒ Failed | - |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.deploy-app.result }}" == "success" ]; then
            echo "| App | âœ… Success | https://${{ secrets.CLOUDFLARE_PAGES_PROJECT_NAME }}.pages.dev |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| App | âŒ Failed | - |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.deploy-api.result }}" == "success" ]; then
            echo "- [API Worker](https://${WORKER_NAME}.workers.dev)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.deploy-app.result }}" == "success" ]; then
            echo "- [App Pages](https://${{ secrets.CLOUDFLARE_PAGES_PROJECT_NAME }}.pages.dev)" >> $GITHUB_STEP_SUMMARY
          fi

